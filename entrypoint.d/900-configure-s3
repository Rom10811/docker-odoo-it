#!/bin/bash
# init-fs-attachment.sh

set -e

# Variables d'environnement avec defaults
DB_NAME=${DB_NAME}
LANGUAGE=${LANGUAGE:-"fr_FR"}
ODOO_ARGS=${ODOO_ARGS}

# Variables spécifiques pour fs.storage
FS_STORAGE_NAME=${FS_STORAGE_NAME:-"default_storage"}
FS_STORAGE_CODE=${FS_STORAGE_CODE:-"default"}
FS_STORAGE_PROTOCOL=${FS_STORAGE_PROTOCOL:-"file"}
FS_STORAGE_DIRECTORY_PATH=${FS_STORAGE_DIRECTORY_PATH:-"/opt/odoo/filestore"}
FS_STORAGE_OPTIONS=${FS_STORAGE_OPTIONS:-"{}"}

# Variables de connexion PostgreSQL
PGHOST=${PGHOST:-${DB_HOST:-"localhost"}}
PGPORT=${PGPORT:-${DB_PORT:-"5432"}}
PGUSER=${PGUSER:-${DB_USER:-"odoo"}}
PGPASSWORD=${PGPASSWORD:-${DB_PASSWORD:-"odoo"}}

export PGPASSWORD

log() {
    echo "[$(date '+%H:%M:%S')] $1"
}

# Fonction pour vérifier si un module Odoo est installé
module_installed() {
    local db_name="$1"
    local module_name="$2"

    # Vérifier si le module est installé (state = 'installed')
    local installed=$(psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$db_name" -tAc \
        "SELECT COUNT(*) FROM ir_module_module WHERE name = '$module_name' AND state = 'installed';" 2>/dev/null || echo "0")

    [ "$installed" -gt 0 ]
}

# Vérifier si la DB_NAME est définie
if [ -z "$DB_NAME" ]; then
    log "DB_NAME is not set, skipping S3 configuration"
    exit 0
fi

# Vérifier si FS_STORAGE_OPTIONS est défini et non vide (autre que "{}")
if [ -z "$FS_STORAGE_OPTIONS" ] || [ "$FS_STORAGE_OPTIONS" = "{}" ]; then
    log "FS_STORAGE_OPTIONS is not configured, skipping S3 configuration"
    exit 0
fi

log "Initializing Odoo with fs_attachment module"
log "Database: $DB_NAME"

# 1. Installation du module moka_s3 (seulement si pas déjà installé)
if module_installed "$DB_NAME" "moka_s3"; then
    log "Module moka_s3 is already installed, skipping installation"
else
    log "Installing moka_s3 module..."
    odoo \
        -d "$DB_NAME" \
        --init="moka_s3" \
        --no-xmlrpc \
        --stop-after-init \
        $ODOO_ARGS
fi

# 2. Création du record fs.storage via script Python
log "Creating fs.storage record..."
python3 << EOF
import odoo
from odoo import api, SUPERUSER_ID
import os

# Configuration de la base
odoo.tools.config.parse_config([
    '-d', '$DB_NAME',
    '--no-xmlrpc'
])

# Initialisation du registre
registry = odoo.registry('$DB_NAME')

with registry.cursor() as cr:
    env = api.Environment(cr, SUPERUSER_ID, {})

    # Vérification si le record existe déjà
    existing_storage = env['fs.storage'].search([('code', '=', '$FS_STORAGE_CODE')])

    if not existing_storage:
        # Création du record fs.storage
        storage_vals = {
            'name': '$FS_STORAGE_NAME',
            'code': '$FS_STORAGE_CODE',
            'protocol': 's3',
            'directory_path': '$FS_STORAGE_DIRECTORY_PATH',
            'options': '$FS_STORAGE_OPTIONS',
            'optimizes_directory_path': True,
            'use_as_default_for_attachments': True,
        }

        storage = env['fs.storage'].create(storage_vals)
        print(f"Created fs.storage record: {storage.name} (ID: {storage.id})")
    else:
        print(f"fs.storage record already exists: {existing_storage.name} (ID: {existing_storage.id})")

    # Commit des changements
    cr.commit()
EOF

log "fs_attachment module installation and configuration completed!"
log "Storage '$FS_STORAGE_CODE' is now set as default for attachments"
